# Проверка запроса дерева структуры (/tree endpoint)

**Дата проверки:** 2025-11-10  
**Jira инстанс:** https://job.sbertroika.ru

## Результаты проверки

### ✅ Что работает:

1. **Инициализация сессии** - успешно получает cookies из `/rest/structure/1/structure/138/tree` endpoint
2. **Обработка ошибок** - корректно обрабатывает HTML ответы и 404 ошибки, пробует следующие endpoints
3. **Определение редиректа на логин** - правильно определяет редирект на `login.jsp` и пробует следующий endpoint

### ❌ Что не работает:

1. **Запрос дерева структуры** - все endpoints возвращают 404 или редирект на страницу логина:
   - `/rest/structure/latest/structure/138/tree` → 404
   - `/rest/structure/1/structure/138/tree` → редирект на `login.jsp?permissionViolation=true`
   - `/rest/structure/1.0/structure/138/tree` → 404
   - `/rest/structure/2.0/structure/138/tree` → 404
   - Все альтернативные endpoints (`hierarchy`, `element`) → 404

## Внесенные изменения

### 1. Исправлена логика аутентификации для `/tree` endpoint

**Было:** Использовался Basic auth с email и API token  
**Стало:** Используется Bearer token + cookies (как при инициализации)

```typescript
// Для /tree endpoint используем Bearer token + cookies
if (endpoint.includes('/tree')) {
  requestHeaders['Authorization'] = this.authHeader;
  if (this.sessionCookies) {
    requestHeaders['Cookie'] = this.sessionCookies;
  }
}
```

### 2. Улучшена обработка ошибок

- HTML ответы обрабатываются как ошибки endpoint, код пробует следующий endpoint
- 404 ошибки обрабатываются корректно, код пробует следующий endpoint
- Редирект на страницу логина определяется и обрабатывается

### 3. Добавлена поддержка `/latest` версии API

Добавлен `/latest` в список пробуемых endpoints (как для списка структур)

### 4. Улучшена обработка редиректов

- Используется `redirect: 'manual'` для `/tree` endpoint (как при инициализации)
- Cookies обновляются из заголовков редиректа
- Редирект на страницу логина определяется и обрабатывается

## Проблема

Основная проблема: **`/tree` endpoint требует специальной аутентификации, которая не работает с текущими cookies или Bearer token**.

При инициализации cookies получаются из редиректа `/rest/structure/1/structure/138/tree`, но эти cookies не дают доступа к реальному endpoint - при запросе происходит редирект на страницу логина с `permissionViolation=true`.

## Возможные причины

1. **Cookies устарели** - cookies, полученные при инициализации, могут быть недействительными для реальных запросов
2. **Недостаточно прав** - пользователь может не иметь прав на доступ к `/tree` endpoint
3. **Endpoint не поддерживается** - `/tree` endpoint может быть недоступен в этой версии Jira Structure API
4. **Требуется другая аутентификация** - может потребоваться другой способ аутентификации для `/tree` endpoint

## Рекомендации

1. **Проверить документацию Structure API** - уточнить правильный способ получения дерева структуры для вашей версии плагина
2. **Проверить права доступа** - убедиться, что пользователь имеет права на просмотр элементов структур
3. **Попробовать альтернативные endpoints** - использовать другие endpoints для получения дерева структуры
4. **Проверить версию плагина** - убедиться, что установлена поддерживаемая версия Jira Structure

## Текущий статус

- ✅ Код корректно обрабатывает ошибки и пробует все доступные endpoints
- ✅ Логика аутентификации исправлена
- ❌ `/tree` endpoint не работает - все варианты возвращают 404 или редирект на логин
- ⚠️ Возможно, требуется другой подход для получения дерева структуры

## Следующие шаги

1. Проверить документацию Structure API для вашей версии
2. Попробовать использовать другие endpoints для получения дерева структуры
3. Проверить логи Jira на предмет дополнительной информации об ошибках
4. Связаться с администратором Jira для уточнения правильных endpoints




